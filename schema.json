{
  "type": "object",
  "required": [
    "general_config",
    "sites"
  ],
  "properties": {
    "general_config": {
      "$ref": "#/definitions/GeneralConfig"
    },
    "sites": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/Site"
      }
    },
    "components": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/ComponentConfig"
      },
      "default": []
    },
    "sops": {},
    "output_path": {
      "type": "string",
      "default": "deployments"
    },
    "file": {
      "type": "string"
    }
  },
  "description": "Main MACH configuration object.",
  "$schema": "http://json-schema.org/draft-06/schema#",
  "definitions": {
    "GeneralConfig": {
      "type": "object",
      "required": [
        "environment",
        "terraform_config",
        "cloud"
      ],
      "properties": {
        "environment": {
          "type": "string"
        },
        "terraform_config": {
          "$ref": "#/definitions/TerraformConfig"
        },
        "cloud": {
          "type": "string",
          "enum": [
            "aws",
            "azure"
          ]
        },
        "sentry": {
          "$ref": "#/definitions/SentryConfig"
        },
        "azure": {
          "$ref": "#/definitions/AzureConfig"
        },
        "contentful": {
          "$ref": "#/definitions/ContentfulConfig"
        },
        "amplience": {
          "$ref": "#/definitions/AmplienceConfig"
        }
      },
      "description": "Config that is shared across sites."
    },
    "TerraformConfig": {
      "type": "object",
      "properties": {
        "azure_remote_state": {
          "$ref": "#/definitions/AzureTFState"
        },
        "aws_remote_state": {
          "$ref": "#/definitions/AWSTFState"
        },
        "providers": {
          "$ref": "#/definitions/TerraformProviders"
        }
      },
      "description": "Terraform configuration."
    },
    "AzureTFState": {
      "type": "object",
      "required": [
        "resource_group",
        "storage_account",
        "container_name",
        "state_folder"
      ],
      "properties": {
        "resource_group": {
          "type": "string"
        },
        "storage_account": {
          "type": "string"
        },
        "container_name": {
          "type": "string"
        },
        "state_folder": {
          "type": "string"
        }
      },
      "description": "Azure storage account state backend configuration."
    },
    "AWSTFState": {
      "type": "object",
      "required": [
        "bucket",
        "key_prefix",
        "region"
      ],
      "properties": {
        "bucket": {
          "type": "string"
        },
        "key_prefix": {
          "type": "string"
        },
        "region": {
          "type": "string"
        },
        "role_arn": {
          "type": "string"
        },
        "lock_table": {
          "type": "string"
        }
      },
      "description": "AWS S3 bucket state backend configuration."
    },
    "TerraformProviders": {
      "type": "object",
      "properties": {
        "aws": {
          "type": "string"
        },
        "azure": {
          "type": "string"
        },
        "commercetools": {
          "type": "string"
        },
        "sentry": {
          "type": "string"
        },
        "contentful": {
          "type": "string"
        }
      },
      "description": "Terraform provider version overwrites."
    },
    "SentryConfig": {
      "type": "object",
      "properties": {
        "dsn": {
          "type": "string"
        },
        "rate_limit_window": {
          "type": "integer"
        },
        "rate_limit_count": {
          "type": "integer"
        },
        "auth_token": {
          "type": "string"
        },
        "base_url": {
          "type": "string"
        },
        "project": {
          "type": "string"
        },
        "organization": {
          "type": "string"
        }
      },
      "description": "Global Sentry configuration."
    },
    "AzureConfig": {
      "type": "object",
      "required": [
        "tenant_id",
        "subscription_id",
        "region"
      ],
      "properties": {
        "tenant_id": {
          "type": "string"
        },
        "subscription_id": {
          "type": "string"
        },
        "region": {
          "type": "string"
        },
        "frontdoor": {
          "$ref": "#/definitions/FrontDoorSettings"
        },
        "resources_prefix": {
          "type": "string",
          "default": ""
        },
        "service_object_ids": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "default": {}
        },
        "service_plans": {
          "type": "object",
          "additionalProperties": {},
          "default": {}
        }
      },
      "description": "Azure configuration."
    },
    "FrontDoorSettings": {
      "type": "object",
      "required": [
        "resource_group"
      ],
      "properties": {
        "resource_group": {
          "type": "string"
        },
        "suppress_changes": {
          "type": "boolean",
          "default": false
        }
      },
      "description": "Frontdoor settings."
    },
    "ContentfulConfig": {
      "type": "object",
      "required": [
        "cma_token",
        "organization_id"
      ],
      "properties": {
        "cma_token": {
          "type": "string"
        },
        "organization_id": {
          "type": "string"
        }
      },
      "description": "Generic Contenful configuration."
    },
    "AmplienceConfig": {
      "type": "object",
      "required": [
        "client_id",
        "client_secret"
      ],
      "properties": {
        "client_id": {
          "type": "string"
        },
        "client_secret": {
          "type": "string"
        }
      },
      "description": "Generic Amplience configuration."
    },
    "Site": {
      "type": "object",
      "required": [
        "identifier"
      ],
      "properties": {
        "identifier": {
          "type": "string"
        },
        "endpoints": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "default": {}
        },
        "commercetools": {
          "$ref": "#/definitions/CommercetoolsSettings"
        },
        "contentful": {
          "$ref": "#/definitions/ContentfulSettings"
        },
        "amplience": {
          "$ref": "#/definitions/AmplienceSettings"
        },
        "apollo_federation": {
          "$ref": "#/definitions/ApolloFederationSettings"
        },
        "azure": {
          "$ref": "#/definitions/SiteAzureSettings"
        },
        "aws": {
          "$ref": "#/definitions/SiteAWSSettings"
        },
        "components": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/Component"
          },
          "default": []
        },
        "sentry": {
          "$ref": "#/definitions/SentryDsn"
        }
      },
      "description": "Site definition."
    },
    "CommercetoolsSettings": {
      "type": "object",
      "required": [
        "project_key",
        "client_id",
        "client_secret",
        "scopes",
        "currencies",
        "languages",
        "countries"
      ],
      "properties": {
        "project_key": {
          "type": "string"
        },
        "client_id": {
          "type": "string"
        },
        "client_secret": {
          "type": "string"
        },
        "scopes": {
          "type": "string"
        },
        "currencies": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "languages": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "countries": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "token_url": {
          "type": "string",
          "default": "https://auth.europe-west1.gcp.commercetools.com"
        },
        "api_url": {
          "type": "string",
          "default": "https://api.europe-west1.gcp.commercetools.com"
        },
        "messages_enabled": {
          "type": "boolean",
          "default": true
        },
        "channels": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/CommercetoolsChannel"
          },
          "default": []
        },
        "taxes": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/CommercetoolsTax"
          },
          "default": []
        },
        "stores": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/Store"
          },
          "default": []
        },
        "create_frontend_credentials": {
          "type": "boolean",
          "default": true
        }
      },
      "description": "commercetools configuration."
    },
    "CommercetoolsChannel": {
      "type": "object",
      "required": [
        "key",
        "roles"
      ],
      "properties": {
        "key": {
          "type": "string"
        },
        "roles": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "name": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "description": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        }
      },
      "description": "commercetools channel definition."
    },
    "CommercetoolsTax": {
      "type": "object",
      "required": [
        "country",
        "amount",
        "name"
      ],
      "properties": {
        "country": {
          "type": "string"
        },
        "amount": {
          "type": "number"
        },
        "name": {
          "type": "string"
        }
      },
      "description": "commercetools tax definition."
    },
    "Store": {
      "type": "object",
      "required": [
        "name",
        "key"
      ],
      "properties": {
        "name": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "key": {
          "type": "string"
        },
        "languages": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "distribution_channels": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "supply_channels": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": []
        }
      },
      "description": "commercetools store definition."
    },
    "ContentfulSettings": {
      "type": "object",
      "required": [
        "space"
      ],
      "properties": {
        "space": {
          "type": "string"
        },
        "default_locale": {
          "type": "string",
          "default": "en-US"
        },
        "cma_token": {
          "type": "string",
          "default": ""
        },
        "organization_id": {
          "type": "string",
          "default": ""
        }
      },
      "description": "Contentful settings."
    },
    "AmplienceSettings": {
      "type": "object",
      "required": [
        "hub_id"
      ],
      "properties": {
        "hub_id": {
          "type": "string"
        },
        "client_id": {
          "type": "string",
          "default": ""
        },
        "client_secret": {
          "type": "string",
          "default": ""
        }
      },
      "description": "Amplience settings."
    },
    "ApolloFederationSettings": {
      "type": "object",
      "required": [
        "api_key"
      ],
      "properties": {
        "api_key": {
          "type": "string"
        },
        "graph": {
          "type": "string",
          "default": ""
        },
        "graph_variant": {
          "type": "string",
          "default": ""
        }
      },
      "description": "Apollo Federation settings."
    },
    "SiteAzureSettings": {
      "type": "object",
      "properties": {
        "service_object_ids": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "default": {}
        },
        "frontdoor": {
          "$ref": "#/definitions/FrontDoorSettings"
        },
        "alert_group": {
          "$ref": "#/definitions/AlertGroup"
        },
        "resource_group": {
          "type": "string",
          "default": ""
        },
        "tenant_id": {
          "type": "string",
          "default": ""
        },
        "subscription_id": {
          "type": "string",
          "default": ""
        },
        "region": {
          "type": "string",
          "default": ""
        },
        "service_plans": {
          "type": "object",
          "additionalProperties": {},
          "default": {}
        }
      },
      "description": "Site-specific Azure settings."
    },
    "AlertGroup": {
      "type": "object",
      "required": [
        "name"
      ],
      "properties": {
        "name": {
          "type": "string"
        },
        "alert_emails": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "webhook_url": {
          "type": "string"
        },
        "logic_app": {
          "type": "string"
        }
      },
      "description": "Alert group configuration."
    },
    "SiteAWSSettings": {
      "type": "object",
      "required": [
        "account_id",
        "region"
      ],
      "properties": {
        "account_id": {
          "type": "integer"
        },
        "region": {
          "type": "string"
        },
        "deploy_role_arn": {
          "type": "string"
        },
        "extra_providers": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/AWSProvider"
          },
          "default": []
        }
      },
      "description": "Site-specific AWS settings."
    },
    "AWSProvider": {
      "type": "object",
      "required": [
        "name",
        "region"
      ],
      "properties": {
        "name": {
          "type": "string"
        },
        "region": {
          "type": "string"
        }
      },
      "description": "AWS provider configuration."
    },
    "Component": {
      "type": "object",
      "required": [
        "name"
      ],
      "properties": {
        "name": {
          "type": "string"
        },
        "variables": {
          "type": "object",
          "default": {}
        },
        "secrets": {
          "type": "object",
          "default": {}
        },
        "store_variables": {
          "type": "object",
          "additionalProperties": {
            "type": "object"
          },
          "default": {}
        },
        "store_secrets": {
          "type": "object",
          "additionalProperties": {
            "type": "object"
          },
          "default": {}
        },
        "short_name": {
          "type": "string"
        },
        "health_check_path": {
          "type": "string"
        },
        "sentry": {
          "$ref": "#/definitions/SentryDsn"
        },
        "azure": {
          "$ref": "#/definitions/ComponentAzureConfig"
        }
      },
      "description": "Component configuration."
    },
    "SentryDsn": {
      "type": "object",
      "properties": {
        "dsn": {
          "type": "string"
        },
        "rate_limit_window": {
          "type": "integer"
        },
        "rate_limit_count": {
          "type": "integer"
        }
      },
      "description": "Specific sentry DSN settings."
    },
    "ComponentAzureConfig": {
      "type": "object",
      "properties": {
        "service_plan": {
          "type": "string"
        }
      },
      "description": "ComponentAzureConfig(service_plan: Union[str, NoneType] = None)"
    },
    "ComponentConfig": {
      "type": "object",
      "required": [
        "name",
        "source",
        "version"
      ],
      "properties": {
        "name": {
          "type": "string"
        },
        "source": {
          "type": "string"
        },
        "version": {
          "type": "string"
        },
        "short_name": {
          "type": "string"
        },
        "integrations": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "endpoints": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "default": {}
        },
        "health_check_path": {
          "type": "string"
        },
        "azure": {
          "$ref": "#/definitions/ComponentAzureConfig"
        },
        "branch": {
          "type": "string"
        },
        "artifacts": {
          "type": "object",
          "patternProperties": {
            "^[A-Za-z_-][A-Za-z0-9_-]*$": {
              "type": "object",
              "properties": {
                "script": {
                  "type": "string"
                },
                "filename": {
                  "type": "string"
                },
                "workdir": {
                  "type": "string"
                }
              }
            }
          }
        }
      },
      "description": "Component definition."
    }
  }
}
