{
  "terraform": [
    {
      "backend": [
        {
          "azurerm": {
            "resource_group_name": [
              "my-shared-rg"
            ],
            "storage_account_name": [
              "mysharedsaterra"
            ],
            "container_name": [
              "tfstate"
            ],
            "key": [
              "test/mach-site-eu"
            ]
          }
        }
      ]
    },
    {
      "required_providers": [
        {
          "azurerm": [
            {
              "version": "~> 2.29.0"
            }
          ],
          "commercetools": [
            {
              "source": "labd/commercetools",
              "version": "~> 0.24.1"
            }
          ],
          "sentry": [
            {
              "source": "jianyuan/sentry",
              "version": "~> 0.6.0"
            }
          ]
        }
      ]
    }
  ],
  "provider": [
    {
      "sentry": {
        "token": [
          "JdOheW3IzlsXBOPNdaMZgXoMcHqyf8CJMjBnfVHD3laXPpN23oAZG8KOPAiYfeGr"
        ],
        "base_url": [
          "https://sentry.io/api/"
        ]
      }
    },
    {
      "commercetools": {
        "client_id": [
          "6SWM8ttjAYll-f9dopjdt"
        ],
        "client_secret": [
          "Q6gu2Hxlbhwv7wtrgPPydmS--6wv7tyh"
        ],
        "project_key": [
          "mach-site-eu"
        ],
        "scopes": [
          "manage_api_clients:mach-site-eu manage_project:mach-site-eu view_api_clients:mach-site-eu"
        ],
        "token_url": [
          "https://auth.europe-west1.gcp.commercetools.com"
        ],
        "api_url": [
          "https://api.europe-west1.gcp.commercetools.com"
        ]
      }
    },
    {
      "azurerm": {
        "subscription_id": [
          "086bd7e7-0755-44ab-a730-7a0b8ad4883f"
        ],
        "tenant_id": [
          "e180345a-b3e1-421f-b448-672ab50d8502"
        ],
        "skip_provider_registration": [
          true
        ],
        "features": [
          {}
        ]
      }
    }
  ],
  "resource": [
    {
      "commercetools_project_settings": {
        "project": {
          "name": [
            "mach-site-eu"
          ],
          "countries": [
            [
              "NL",
              "GB"
            ]
          ],
          "currencies": [
            [
              "GBP",
              "EUR"
            ]
          ],
          "languages": [
            [
              "nl-NL",
              "en-GB"
            ]
          ],
          "messages": [
            {
              "enabled": true
            }
          ]
        }
      }
    },
    {
      "null_resource": {
        "commercetools": {
          "depends_on": [
            [
              "${commercetools_project_settings.project}"
            ]
          ]
        }
      }
    },
    {
      "commercetools_api_client": {
        "frontend_credentials": {
          "name": [
            "frontend_credentials_terraform"
          ],
          "scope": [
            [
              "manage_my_profile:mach-site-eu",
              "manage_my_orders:mach-site-eu",
              "view_states:mach-site-eu",
              "manage_my_shopping_lists:mach-site-eu",
              "view_products:mach-site-eu",
              "manage_my_payments:mach-site-eu",
              "create_anonymous_token:mach-site-eu",
              "view_project_settings:mach-site-eu"
            ]
          ]
        }
      }
    },
    {
      "azurerm_resource_group": {
        "main": {
          "name": [
            "${format(\"%s-rg\",local.name_prefix)}"
          ],
          "location": [
            "West Europe"
          ],
          "tags": [
            "${local.tags}"
          ]
        }
      }
    },
    {
      "azurerm_dns_cname_record": {
        "mach-site-eu": {
          "name": [
            "mach-site-eu"
          ],
          "zone_name": [
            "${data.azurerm_dns_zone.domain.name}"
          ],
          "resource_group_name": [
            "mach-shared-we-rg"
          ],
          "ttl": [
            600
          ],
          "record": [
            "${local.frontdoor_domain}"
          ]
        }
      }
    },
    {
      "azurerm_frontdoor": {
        "app-service": {
          "name": [
            "${format(\"%s-fd\",local.name_prefix)}"
          ],
          "resource_group_name": [
            "${local.resource_group_name}"
          ],
          "enforce_backend_pools_certificate_name_check": [
            false
          ],
          "tags": [
            "${local.tags}"
          ],
          "backend_pool_load_balancing": [
            {
              "name": [
                "lbSettings"
              ]
            }
          ],
          "frontend_endpoint": [
            {
              "name": [
                "${local.frontdoor_domain_identifier}"
              ],
              "host_name": [
                "${local.frontdoor_domain}"
              ],
              "custom_https_provisioning_enabled": [
                false
              ]
            },
            {
              "name": [
                "${local.frontdoor_external_domain_identifier}"
              ],
              "host_name": [
                "${local.frontdoor_external_domain}"
              ],
              "custom_https_provisioning_enabled": [
                true
              ],
              "custom_https_configuration": [
                {
                  "certificate_source": [
                    "AzureKeyVault"
                  ],
                  "azure_key_vault_certificate_vault_id": [
                    "${data.azurerm_key_vault.ssl.id}"
                  ],
                  "azure_key_vault_certificate_secret_name": [
                    "wildcard-mach-services-net"
                  ],
                  "azure_key_vault_certificate_secret_version": [
                    "oIXGVSNdwVAX7i6uUcCl"
                  ]
                }
              ]
            }
          ],
          "depends_on": [
            [
              "${azurerm_dns_cname_record.mach-site-eu}"
            ]
          ],
          "backend_pool_health_probe": [
            {
              "name": [
                "us-payment-hpSettings"
              ],
              "path": [
                "/us-payment/healthchecks"
              ],
              "protocol": [
                "Https"
              ],
              "enabled": [
                false
              ],
              "probe_method": [
                "HEAD"
              ]
            }
          ],
          "routing_rule": [
            {
              "name": [
                "http-https-redirect"
              ],
              "accepted_protocols": [
                [
                  "Http"
                ]
              ],
              "patterns_to_match": [
                [
                  "/*"
                ]
              ],
              "frontend_endpoints": [
                [
                  "${local.frontdoor_domain_identifier}",
                  "${local.frontdoor_external_domain_identifier}"
                ]
              ],
              "redirect_configuration": [
                {
                  "redirect_type": [
                    "PermanentRedirect"
                  ],
                  "redirect_protocol": [
                    "HttpsOnly"
                  ]
                }
              ]
            },
            {
              "name": [
                "us-payment-routing-rule"
              ],
              "accepted_protocols": [
                [
                  "Https"
                ]
              ],
              "patterns_to_match": [
                [
                  "/us-payment/*"
                ]
              ],
              "frontend_endpoints": [
                [
                  "${local.frontdoor_domain_identifier}",
                  "${local.frontdoor_external_domain_identifier}"
                ]
              ],
              "forwarding_configuration": [
                {
                  "forwarding_protocol": [
                    "MatchRequest"
                  ],
                  "backend_pool_name": [
                    "us-payment"
                  ]
                }
              ]
            }
          ],
          "backend_pool": [
            {
              "name": [
                "us-payment"
              ],
              "backend": [
                {
                  "host_header": [
                    "${local.name_prefix}-func-us-payment.azurewebsites.net"
                  ],
                  "address": [
                    "${local.name_prefix}-func-us-payment.azurewebsites.net"
                  ],
                  "http_port": [
                    80
                  ],
                  "https_port": [
                    443
                  ]
                }
              ],
              "load_balancing_name": [
                "lbSettings"
              ],
              "health_probe_name": [
                "us-payment-hpSettings"
              ]
            }
          ]
        }
      }
    },
    {
      "azurerm_app_service_plan": {
        "functionapps": {
          "name": [
            "${format(\"%s-plan\",local.name_prefix)}"
          ],
          "resource_group_name": [
            "${local.resource_group_name}"
          ],
          "location": [
            "${local.resource_group_location}"
          ],
          "kind": [
            "FunctionApp"
          ],
          "reserved": [
            true
          ],
          "sku": [
            {
              "tier": [
                "Dynamic"
              ],
              "size": [
                "Y1"
              ]
            }
          ],
          "tags": [
            "${local.tags}"
          ]
        }
      }
    },
    {
      "sentry_key": {
        "api-extensions": {
          "organization": [
            "labd"
          ],
          "project": [
            "mach"
          ],
          "name": [
            "mach-site-eu_api-extensions"
          ],
          "rate_limit_window": [
            21600
          ],
          "rate_limit_count": [
            100
          ]
        }
      }
    }
  ],
  "output": [
    {
      "frontend_channels": {
        "value": [
          []
        ]
      }
    },
    {
      "frontend_client_scope": {
        "value": [
          "${commercetools_api_client.frontend_credentials.scope}"
        ]
      }
    },
    {
      "frontend_client_id": {
        "value": [
          "${commercetools_api_client.frontend_credentials.id}"
        ]
      }
    },
    {
      "frontend_client_secret": {
        "value": [
          "${commercetools_api_client.frontend_credentials.secret}"
        ]
      }
    }
  ],
  "locals": [
    {
      "tenant_id": [
        "e180345a-b3e1-421f-b448-672ab50d8502"
      ],
      "region": [
        "westeurope"
      ],
      "subscription_id": [
        "086bd7e7-0755-44ab-a730-7a0b8ad4883f"
      ],
      "project_key": [
        "mach-site-eu"
      ],
      "region_short": [
        "we"
      ],
      "name_prefix": [
        "${format(\"mach-site-eu-%s\",local.region_short)}"
      ],
      "service_object_ids": [
        {}
      ],
      "tags": [
        {
          "project_key": "mach-site-eu"
        }
      ]
    },
    {
      "resource_group_name": [
        "${azurerm_resource_group.main.name}"
      ],
      "resource_group_location": [
        "${azurerm_resource_group.main.location}"
      ]
    },
    {
      "frontdoor_domain": [
        "${format(\"%s-fd.azurefd.net\",local.name_prefix)}"
      ],
      "frontdoor_domain_identifier": [
        "${replace(local.frontdoor_domain,\".\",\"-\")}"
      ]
    },
    {
      "frontdoor_external_domain": [
        "mach-site-eu.mach-services.net"
      ],
      "frontdoor_external_domain_identifier": [
        "${replace(local.frontdoor_external_domain,\".\",\"-\")}"
      ]
    }
  ],
  "data": [
    {
      "azurerm_dns_zone": {
        "domain": {
          "name": [
            "mach-services.net"
          ],
          "resource_group_name": [
            "mach-shared-we-rg"
          ]
        }
      }
    },
    {
      "azurerm_key_vault": {
        "ssl": {
          "name": [
            "machsharedwekvcdn"
          ],
          "resource_group_name": [
            "mach-shared-we-rg"
          ]
        }
      }
    },
    {
      "external": {
        "sync_triggers_us-payment": {
          "program": [
            [
              "bash",
              "-c",
              "az rest --method post --uri 'https://management.azure.com/subscriptions/${local.subscription_id}/resourceGroups/${local.resource_group_name}/providers/Microsoft.Web/sites/${module.us-payment.app_service_name}/syncfunctiontriggers?api-version=2016-08-01'"
            ]
          ],
          "depends_on": [
            [
              "${module.us-payment.app_service_name}"
            ]
          ]
        }
      }
    },
    {
      "external": {
        "sync_triggers_api-extensions": {
          "program": [
            [
              "bash",
              "-c",
              "az rest --method post --uri 'https://management.azure.com/subscriptions/${local.subscription_id}/resourceGroups/${local.resource_group_name}/providers/Microsoft.Web/sites/${module.api-extensions.app_service_name}/syncfunctiontriggers?api-version=2016-08-01'"
            ]
          ],
          "depends_on": [
            [
              "${module.api-extensions.app_service_name}"
            ]
          ]
        }
      }
    }
  ],
  "module": [
    {
      "commercetools-config": {
        "source": [
          "git::https://github.com/some-organisation/mach-component-commercetools.git//terraform?ref=1aa9215"
        ],
        "providers": [
          {}
        ],
        "depends_on": [
          [
            "${null_resource.commercetools}"
          ]
        ]
      }
    },
    {
      "us-payment": {
        "source": [
          "git::https://github.com/some-organisation/mach-component-payment.git//terraform?ref=0a9a0b5"
        ],
        "component_version": [
          "0a9a0b5"
        ],
        "environment": [
          "site"
        ],
        "site": [
          "mach-site-eu"
        ],
        "variables": [
          {}
        ],
        "secrets": [
          {}
        ],
        "short_name": [
          "us-payment"
        ],
        "name_prefix": [
          "${local.name_prefix}"
        ],
        "subscription_id": [
          "${local.subscription_id}"
        ],
        "tenant_id": [
          "${local.tenant_id}"
        ],
        "service_object_ids": [
          "${local.service_object_ids}"
        ],
        "region": [
          "${local.region}"
        ],
        "resource_group_name": [
          "${local.resource_group_name}"
        ],
        "resource_group_location": [
          "${local.resource_group_location}"
        ],
        "app_service_plan_id": [
          "${azurerm_app_service_plan.functionapps.id}"
        ],
        "tags": [
          "${local.tags}"
        ],
        "frontdoor_id": [
          "${azurerm_frontdoor.app-service.header_frontdoor_id}"
        ],
        "ct_project_key": [
          "mach-site-eu"
        ],
        "ct_api_url": [
          "https://api.europe-west1.gcp.commercetools.com"
        ],
        "ct_auth_url": [
          "https://auth.europe-west1.gcp.commercetools.com"
        ],
        "ct_stores": [
          {}
        ],
        "providers": [
          {
            "azurerm": "${azurerm}"
          }
        ],
        "depends_on": [
          [
            "${null_resource.commercetools}"
          ]
        ]
      }
    },
    {
      "api-extensions": {
        "source": [
          "git::https://github.com/some-organisation/mach-component-api-extensions.git//terraform?ref=a4bbb28"
        ],
        "component_version": [
          "a4bbb28"
        ],
        "environment": [
          "site"
        ],
        "site": [
          "mach-site-eu"
        ],
        "variables": [
          {
            "ORDER_PREFIX": "MACH-"
          }
        ],
        "secrets": [
          {}
        ],
        "short_name": [
          "apiexts"
        ],
        "name_prefix": [
          "${local.name_prefix}"
        ],
        "subscription_id": [
          "${local.subscription_id}"
        ],
        "tenant_id": [
          "${local.tenant_id}"
        ],
        "service_object_ids": [
          "${local.service_object_ids}"
        ],
        "region": [
          "${local.region}"
        ],
        "resource_group_name": [
          "${local.resource_group_name}"
        ],
        "resource_group_location": [
          "${local.resource_group_location}"
        ],
        "app_service_plan_id": [
          "${azurerm_app_service_plan.functionapps.id}"
        ],
        "tags": [
          "${local.tags}"
        ],
        "sentry_dsn": [
          "${sentry_key.api-extensions.dsn_secret}"
        ],
        "ct_project_key": [
          "mach-site-eu"
        ],
        "ct_api_url": [
          "https://api.europe-west1.gcp.commercetools.com"
        ],
        "ct_auth_url": [
          "https://auth.europe-west1.gcp.commercetools.com"
        ],
        "ct_stores": [
          {}
        ],
        "providers": [
          {
            "azurerm": "${azurerm}"
          }
        ],
        "depends_on": [
          [
            "${null_resource.commercetools}"
          ]
        ]
      }
    }
  ]
}